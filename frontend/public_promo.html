
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP开放优惠</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f5f7; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    h1 { text-align: center; color: #172b4d; }
    .promo-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
    .promo-item { background-color: #fff; border: 1px solid #dfe1e6; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); transition: all 0.2s ease-in-out; display: flex; flex-direction: column; }
    .promo-item:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .promo-item h3 { margin-top: 0; color: #0052cc; font-size: 1.1em; }
    .promo-item .category { font-size: 0.8em; font-weight: bold; color: #42526e; background-color: #f4f5f7; padding: 3px 8px; border-radius: 4px; display: inline-block; margin-bottom: 10px; }
    .promo-item .desc { color: #505f79; font-size: 0.9em; flex-grow: 1; }
    .promo-item button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; align-self: flex-start; margin-top: 15px; }
    .promo-item button:hover { background-color: #0056b3; }
    .loading, .error { text-align: center; font-size: 18px; color: #6b778c; padding: 50px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: none; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
    .close { color: #aaa; position: absolute; top: 15px; right: 20px; font-size: 32px; font-weight: bold; }
    .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
    #promo-details h2 { margin-top: 0; color: #172b4d; }
    #promo-details p { word-break: break-all; color: #42526e; }
    #promo-details a { color: #0052cc; }
    #promo-qrcode { display: none; width: 160px; height: 160px; margin: 15px auto; border: 1px solid #dfe1e6; border-radius: 8px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>MCP开放优惠</h1>
    <div id="promo-list" class="promo-list">
      <div class="loading">正在加载优惠信息...</div>
    </div>
  </div>

  <div id="link-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="promo-details">
        <h2>推广详情</h2>
        <div id="h5-section" class="hidden">
          <p><strong>H5链接:</strong> <a id="promo-h5" href="#" target="_blank"></a></p>
        </div>
        <div id="miniapp-section" class="hidden">
          <p><strong>小程序:</strong></p>
          <img id="promo-qrcode" src="" alt="小程序码"/>
          <p id="promo-miniapp-info"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const promoList = document.getElementById('promo-list');
    const modal = document.getElementById('link-modal');
    const closeModal = document.getElementsByClassName('close')[0];
    
    const BACKEND_URL = 'https://mcps-znbg.onrender.com';
    let allPromos = [];

    document.addEventListener('DOMContentLoaded', () => {
      fetch(`${BACKEND_URL}/api/mcp/jutuike/public_promo_list`)
        .then(response => response.ok ? response.json() : Promise.reject(`网络请求失败: ${response.status}`))
        .then(data => {
          if (data.code === 200) {
            allPromos = data.data;
            renderPromoList(allPromos);
          } else {
            showError('无法加载优惠信息: ' + (data.msg || '未知错误'));
          }
        })
        .catch(error => {
          console.error('加载优惠信息时出错:', error);
          showError(`加载失败, 请检查后端服务是否在线。错误: ${error}`);
        });
    });

    function renderPromoList(promos) {
      promoList.innerHTML = '';
      if (!promos || promos.length === 0) {
        promoList.innerHTML = '<div class="loading">暂无优惠信息。</div>';
        return;
      }
      promos.forEach(promo => {
        const promoItem = document.createElement('div');
        promoItem.className = 'promo-item';
        promoItem.innerHTML = `
          <span class="category">${promo.category}</span>
          <h3>${promo.activityName}</h3>
          <p class="desc">${promo.desc}</p>
          <button onclick="showPromoLink('${promo.actId}')">获取链接</button>
        `;
        promoList.appendChild(promoItem);
      });
    }

    function showError(message) {
      promoList.innerHTML = `<div class="error">${message}</div>`;
    }

    function showPromoLink(actId) {
      const promo = allPromos.find(p => p.actId === actId);
      if (!promo) return;

      const h5Section = document.getElementById('h5-section');
      const miniappSection = document.getElementById('miniapp-section');

      // Reset visibility
      h5Section.classList.add('hidden');
      miniappSection.classList.add('hidden');

      // H5 Link
      if (promo.link) {
        document.getElementById('promo-h5').href = promo.link;
        document.getElementById('promo-h5').textContent = '点击跳转';
        h5Section.classList.remove('hidden');
      }

      // Mini Program
      if (promo.miniAppLink && promo.miniAppLink.app_id) {
        const qrCodeImg = document.getElementById('promo-qrcode');
        const miniappInfo = document.getElementById('promo-miniapp-info');
        miniappInfo.textContent = `AppID: ${promo.miniAppLink.app_id}`;

        if (promo.miniAppLink.miniCode) {
          qrCodeImg.src = promo.miniAppLink.miniCode;
          qrCodeImg.style.display = 'block';
        } else {
          qrCodeImg.style.display = 'none';
        }
        miniappSection.classList.remove('hidden');
      } 

      modal.style.display = 'block';
    }

    closeModal.onclick = () => modal.style.display = 'none';
    window.onclick = (event) => {
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    };
  </script>
</body>
</html>
