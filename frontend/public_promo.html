
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP开放优惠</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background-color: #f4f5f7; }
    .container { max-width: 960px; margin: 0 auto; }
    h1 { text-align: center; color: #333; }
    .promo-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .promo-item { background-color: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s; }
    .promo-item:hover { transform: translateY(-5px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .promo-item h3 { margin-top: 0; color: #0056b3; }
    .promo-item p { color: #666; font-size: 14px; }
    .promo-item button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; }
    .promo-item button:hover { background-color: #0056b3; }
    .loading, .error { text-align: center; font-size: 18px; color: #888; padding: 50px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
    .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
    #promo-details p { word-break: break-all; }
  </style>
</head>
<body>
  <div class="container">
    <h1>MCP开放优惠</h1>
    <div id="promo-list" class="promo-list">
      <div class="loading">正在加载优惠信息...</div>
    </div>
  </div>

  <div id="link-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="promo-details">
        <h2>优惠链接</h2>
        <p><strong>H5链接：</strong><a id="promo-h5" href="#" target="_blank"></a></p>
        <p><strong>小程序信息：</strong><span id="promo-miniapp"></span></p>
      </div>
    </div>
  </div>

  <script>
    const promoList = document.getElementById('promo-list');
    const modal = document.getElementById('link-modal');
    const closeModal = document.getElementsByClassName('close')[0];
    
    // --- CONFIGURATION ---
    // Use the backend URL provided by Render
    const BACKEND_URL = 'https://mcps-znbg.onrender.com'; 
    
    // This will store all the promo data fetched from the backend
    let allPromos = [];

    // --- DATA FETCHING ---
    document.addEventListener('DOMContentLoaded', () => {
      fetch(`${BACKEND_URL}/api/mcp/jutuike/public_promo_list`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`网络请求失败，状态码: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.code === 200) {
            allPromos = data.data;
            renderPromoList(allPromos);
          } else {
            showError('无法加载优惠信息: ' + (data.msg || '未知错误'));
          }
        })
        .catch(error => {
          console.error('加载优惠信息时出错:', error);
          showError(`加载失败，请检查后端服务是否正常。错误: ${error.message}`);
        });
    });

    // --- UI RENDERING ---
    function renderPromoList(promos) {
      promoList.innerHTML = ''; // Clear the loading message
      if (promos.length === 0) {
        promoList.innerHTML = '<div class="loading">暂无优惠信息。</div>';
        return;
      }
      promos.forEach(promo => {
        const promoItem = document.createElement('div');
        promoItem.className = 'promo-item';
        promoItem.innerHTML = `
          <h3>${promo.activityName}</h3>
          <p><strong>分类:</strong> ${promo.category}</p>
          <p>${promo.desc}</p>
          <button onclick="showPromoLink('${promo.actId}')">获取链接</button>
        `;
        promoList.appendChild(promoItem);
      });
    }

    function showError(message) {
      promoList.innerHTML = `<div class="error">${message}</div>`;
    }

    // --- MODAL LOGIC ---
    function showPromoLink(actId) {
      const promo = allPromos.find(p => p.actId === actId);
      if (promo) {
        const h5Link = document.getElementById('promo-h5');
        h5Link.href = promo.link || '#';
        h5Link.textContent = promo.link || '无';

        const miniappInfo = document.getElementById('promo-miniapp');
        if (promo.miniAppLink && promo.miniAppLink.app_id) {
          miniappInfo.textContent = `AppID: ${promo.miniAppLink.app_id}, Path: ${promo.miniAppLink.page_path}`;
        } else {
          miniappInfo.textContent = '无';
        }
        
        modal.style.display = 'block';
      }
    }

    closeModal.onclick = () => {
      modal.style.display = 'none';
    };

    window.onclick = (event) => {
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    };
  </script>
</body>
</html>
